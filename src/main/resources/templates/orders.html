<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>주문서</title>
    <link rel="stylesheet" href="/styles.css"> <!-- 스타일 시트 링크 -->
</head>
<body>
<header>
    <!--
        product 상세조회 페이지에서 [구매하기] 버튼을 누른 경우
        POST /payments/orders 호출한 뒤 이동하는 페이지
    -->
    <h1>주문서</h1>
</header>

<main>
    <div class="order-details">
        <h2>주문 상세 정보</h2>
        <form action="#" method="post">
            <input type="hidden" name="orderId" th:value="${orderId}"/>
            <p><strong>제품 명</strong> <span th:text="${productInfo.productNm}">제품명</span></p>
            <p><strong>제품 수량</strong> <span th:text="${productInfo.productCnt}">제품 수량</span></p>
            <p><strong>가격</strong> <span th:text="${productInfo.productPrice}">가격</span></p>
            <button type="submit">결제하기</button>
        </form>
    </div>
</main>

<footer>
    <p>&copy; 2024 Bowmeow. All rights reserved.</p>
</footer>
<script>
    function requestPay(data) {
        console.log(data);
        // 여기서 data 정리해서 밑에다가 데이터 넣어주기!!
        IMP.request_pay(
            {
                pg: "html5_inicis.INIpayTest", // 뭘 넣어야하징?
                pay_method: "card",
                merchant_uid: data.getMerchant_uid, //상점에서 생성한 고유 주문번호
                name: data.getProductName,
                amount: data.getProductPrice,
                buyer_email: "test@portone.io", // 사용자 관련된 걸 어디서 가져올까? 백엔드에서??
                buyer_name: "구매자이름",
                buyer_tel: "010-6222-0160", //필수 파라미터 입니다.
                buyer_addr: "서울특별시 강남구 삼성동",
                buyer_postcode: "123-456",
                // m_redirect_url: "{모바일에서 결제 완료 후 리디렉션 될 URL}",
                escrow: true, //에스크로 결제인 경우 설정
                vbank_due: "YYYYMMDD",
                notice_url: "https://bowmeownotice.store-69f03025-fc9a-4f6a-a044-524da019d0a7",
                bypass: {
                    // PC 경우
                    acceptmethod: "noeasypay", // 간편결제 버튼을 통합결제창에서 제외(PC)
                    // acceptmethod: "cardpoint", // 카드포인트 사용시 설정(PC)4
                    // 모바일 경우
                    P_RESERVED: "noeasypay=Y", // 간편결제 버튼을 통합결제창에서 제외(모바일)
                    // P_RESERVED: "cp_yn=Y", // 카드포인트 사용시 설정(모바일)
                    // P_RESERVED: "twotrs_bank=Y&iosapp=Y&app_scheme=your_app_scheme://", // iOS에서 계좌이체시 결제가 이뤄지던 앱으로 돌아가기
                },
                period: {
                    from: "20240801", //YYYYMMDD
                    to: "20240802", //YYYYMMDD
                },
            },
            function (rsp) {
                if (rsp.success) {
                    // 결제 성공 로직 + 실제 결제 완료되었는지 추가 확인
                    console.log("결제 성공")
                    fetch("/", {
                        method: "PUT",
                        headers: {
                            "Content-Type": "application/json"
                        },
                        // 받는 뭔가가 있나 ?
                        body: JSON.stringify({ imp_uid: rsp.imp_uid, merchant_uid: rsp.merchant_uid })
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                // 성공 처리
                                console.log("진짜 결제 성공")
                            } else {
                                // 실패 처리
                                console.log("진짜 결제 실패")
                            }
                        })
                        .catch(error => {
                            // 에러 처리
                            console.log("에러로 인해 진짜 결제 실패")
                        });

                } else {
                    // 결제 실패 로직
                    console.log("진짜 결제 실패")
                }

            },
        );
    }
</script>
</body>
</html>
